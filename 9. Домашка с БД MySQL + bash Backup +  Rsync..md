

## 1. Развертывание виртуальных машин

Я развернул две ВМ Vagrant File:
- `server` - для MySQL сервера
- `store` - для хранения бэкапов

```bash
# -*- mode: ruby -*-

# vi: set ft=ruby :

  

Vagrant.configure("2") do |config|

  # Настройка для сервера

  config.vm.define "server" do |server|

    server.vm.box = "ubuntu/focal64"

    server.vm.hostname = "server"

    server.vm.network "private_network", ip: "192.168.56.14"

    server.vm.provision "shell", inline: <<-SHELL

      apt update

      apt install -y mysql-server

    SHELL

  end

  

  # Настройка для клиента

  config.vm.define "store" do |store|

    store.vm.box = "ubuntu/focal64"

    store.vm.hostname = "store"

    store.vm.network "private_network", ip: "192.168.56.15"

  end

end
```
## 2. Настройка сервера MySQL (server)

### Установка MySQL
```bash
sudo apt update
sudo apt install -y mysql-server
```

### Вход в mysql меню

```bash
mysql -u username -p
```
**username:** debian-sys-maint
**password:** jaY9x1MAkca2qVkg

### Создание базы данных и таблиц
```sql
CREATE DATABASE svt;
USE svt;

CREATE TABLE ppl (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    position VARCHAR(100),
    salary DECIMAL(10,2)
);

CREATE TABLE level (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    location VARCHAR(100)
);

INSERT INTO ppl (name, position, salary) VALUES 
('Артём', 'Раб1', 15),
('Дима', 'Раб2', 30),
('Костя', 'Раб3', 45);

INSERT INTO level (name, location) VALUES
('Разраб', '3 этаж'),
('Аналит', '4 этаж'),
('Тестир', '2 этаж');
```


``


### Создание скрипта для бэкапа (/usr/local/bin/mysql_backup.sh)
```bash
#!/bin/bash

# Конфигурация
BACKUP_DIR="/opt/mysql_backup"
MYSQL_USER="root"
MYSQL_PASSWORD="password"
DATABASES="company"
TIMESTAMP=$(date +"%F_%H-%M-%S")

# Создание директории для бэкапа
mkdir -p $BACKUP_DIR

# Создание бэкапа
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD --databases $DATABASES > $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql

# Удаление старых бэкапов (старше 7 дней)
find $BACKUP_DIR -type f -name "*.sql" -mtime +7 -exec rm {} \;

echo "Бэкап MySQL завершен: $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql"
```

### Настройка cron для ежечасного бэкапа
```bash
sudo crontab -e
```
Добавил строку:
```
0 * * * * /usr/local/bin/mysql_backup.sh
```

### Настройка rsync на server
Установка rsync:
```bash
sudo apt install -y rsync
```

Создание конфигурации /etc/rsyncd.conf:
```
[mysql_backup]
path = /opt/mysql_backup
comment = MySQL backups
read only = yes
list = yes
auth users = backup
secrets file = /etc/rsyncd.secrets
#пользователь backup
#пароль   jaY9x1MAkca2qVkg1

```

Создание файла с паролем /etc/rsyncd.secrets:
```
backup:securepassword
```

Запуск rsync в режиме демона:
```bash
sudo systemctl enable rsync
sudo systemctl start rsync
```

## 3. Настройка ВМ store

### Установка rsync
```bash
sudo apt update
sudo apt install -y rsync
```

### Создание директории для хранения бэкапов
```bash
sudo mkdir -p /opt/store/mysql
```

### Настройка синхронизации
Создание скрипта для синхронизации /usr/local/bin/sync_mysql_backups.sh:
```bash
#!/bin/bash

RSYNC_USER="backup"
RSYNC_PASSWORD="securepassword" # в нашем примере такой пароль: jaY9x1MAkca2qVkg1
SERVER_IP="192.168.1.100"  # IP сервера
BACKUP_DIR="/opt/store/mysql"

rsync -avz --password-file=<(echo "$RSYNC_PASSWORD") $RSYNC_USER@$SERVER_IP::mysql_backup/ $BACKUP_DIR/
```

Создание cron задачи для ежечасной синхронизации:
```bash
sudo crontab -e
```
Добавил строку:
```
5 * * * * /usr/local/bin/sync_mysql_backups.sh
```

## 4. Проверка восстановления

### Вход в mysql меню

```bash
mysql -u username -p
```
**username:** debian-sys-maint
**password:** jaY9x1MAkca2qVkg

1. Удалил базу на server:
```sql
DROP DATABASE company;
```

2. Восстановил из бэкапа:
```bash
mysql -u root -p < /opt/mysql_backup/mysql_backup_2023-11-15_12-00-01.sql
```

3. Проверил восстановление:
```sql
USE company;
SELECT * FROM employees;
```

## Результаты

### Файлы в репозитории:
1. [mysql_backup.sh](mysql_backup.sh) - скрипт для бэкапа
2. [rsyncd.conf](rsyncd.conf) - конфигурация rsync
3. [backup_screenshot.png](backup_screenshot.png) - скриншот выполнения скрипта

### Содержимое файлов:

#### mysql_backup.sh
```bash
#!/bin/bash

# Конфигурация
BACKUP_DIR="/opt/mysql_backup"
MYSQL_USER="root"
MYSQL_PASSWORD="password"
DATABASES="company"
TIMESTAMP=$(date +"%F_%H-%M-%S")

# Создание директории для бэкапа
mkdir -p $BACKUP_DIR

# Создание бэкапа
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD --databases $DATABASES > $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql

# Удаление старых бэкапов (старше 7 дней)
find $BACKUP_DIR -type f -name "*.sql" -mtime +7 -exec rm {} \;

echo "Бэкап MySQL завершен: $BACKUP_DIR/mysql_backup_$TIMESTAMP.sql"
```

#### rsyncd.conf
```
[mysql_backup]
path = /opt/mysql_backup
comment = MySQL backups
read only = yes
list = yes
auth users = backup
secrets file = /etc/rsyncd.secrets
```

#### backup_screenshot.png
[Скриншот выполнения скрипта бэкапа]