#nfs #redvirt

---

# üìò –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ NFS-–¥–æ–º–µ–Ω–∞ –≤ –†–ï–î –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üñ•Ô∏è 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ NFS-—Å–µ—Ä–≤–µ—Ä–∞ 

### 1.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

```bash
dnf install -y nfs-utils rpcbind nfs-server
```

### 1.2 –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
systemctl enable --now nfs-utils rpcbind.service nfs-server.service
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
systemctl status rpcbind.service nfs-server.service
```

---

## üìÅ 2. –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞

### 2.1 –°–æ–∑–¥–∞—ë–º –∫–∞—Ç–∞–ª–æ–≥

```bash
mkdir -p /export/redvirt-storage
```

### 2.2 –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ (UID 36 = `vdsm`, GID 36 = `kvm`)

```bash
chown 36:36 /export/redvirt-storage
chmod 755 /export/redvirt-storage
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
ls -ld /export/redvirt-storage
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```
drwxr-xr-x. 3 vdsm kvm ...
```

---

## üìÑ 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ NFS

### 3.1 –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º `/etc/exports`

```bash
echo "/export/redvirt-storage *(rw,insecure,nohide,all_squash,anonuid=36,anongid=36,no_subtree_check)" >> /etc/exports
```

### 3.2 –ü—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç

```bash
exportfs -ra
exportfs -v
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```
/export/redvirt-storage
    <world>(sync,wdelay,nohide,no_subtree_check,anonuid=36,anongid=36,sec=sys,rw,insecure,root_squash,all_squash)
```

---

## üî• 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã:

```bash
firewall-cmd --add-service=nfs --permanent
firewall-cmd --add-service=mountd --permanent
firewall-cmd --add-service=rpc-bind --permanent
firewall-cmd --reload
```

---

## üîí 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SELinux (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

### –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞:

```bash
setenforce 0
```

### –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω—É–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:

```bash
chcon -Rt nfs_t /export/redvirt-storage
```

---

## üß™ 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (`rv-host1`)

```bash
showmount -e rv-guest.ksb.local
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:

```
Export list for rv-guest.ksb.local:
/export/redvirt-storage *
```

–ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é:

```bash
mount -t nfs rv-guest.ksb.local:/export/redvirt-storage /mnt/test
```

---

## üì¶ 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ NFS –≤ –†–ï–î –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏

**–ß–µ—Ä–µ–∑ GUI (—Ä–∞–∑–¥–µ–ª 10.2.2 –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞):**

1. –ü–µ—Ä–µ–π—Ç–∏: **–•—Ä–∞–Ω–∏–ª–∏—â–µ ‚Üí –î–æ–º–µ–Ω—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Üí –î–æ–±–∞–≤–∏—Ç—å**
    
2. –¢–∏–ø: `NFS`
    
3. –ò–º—è: `redvirt-storage`
    
4. –°–µ—Ä–≤–µ—Ä: `rv-guest.ksb.local`
    
5. –ü—É—Ç—å: `/export/redvirt-storage`
    
6. –§–æ—Ä–º–∞—Ç: **V4** –∏–ª–∏ **V3** (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ NFS)
    
7. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
    

‚ö†Ô∏è –ö–∞—Ç–∞–ª–æ–≥ **–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π**, –∏–Ω–∞—á–µ –ø–æ—è–≤–∏—Ç—Å—è –æ—à–∏–±–∫–∞ `Physical device initialization failed`.

---

## üü¢ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ–º–µ–Ω –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∫–∞–∫ **–∞–∫—Ç–∏–≤–Ω—ã–π NFS-–¥–æ–º–µ–Ω —Ö—Ä–∞–Ω–µ–Ω–∏—è** –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –†–ï–î –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏.

---

### üß© –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- UID 36 (`vdsm`) ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –†–ï–î –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥.
    
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `all_squash` + `anonuid/anongid`, —á—Ç–æ–±—ã –≤—Å–µ NFS-–∑–∞–ø—Ä–æ—Å—ã —à–ª–∏ –æ—Ç `vdsm`.
    
- –û–ø—Ü–∏—è `nohide` –Ω—É–∂–Ω–∞, –µ—Å–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –±—É–¥—É—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–∏–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏, –∏ —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –∏—Ö –≤–∏–¥–µ–ª.
  