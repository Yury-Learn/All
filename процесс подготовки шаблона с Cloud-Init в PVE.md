

---

## üîß –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞ —Å **Cloud-Init** –≤ PVE

---

### 1. üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π VM

#### –ß–µ—Ä–µ–∑ Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

- **Create VM**
    
- –£–∫–∞–∂–∏:
    
    - _VM ID_: –Ω–∞–ø—Ä–∏–º–µ—Ä `9000`
        
    - _Name_: `ubuntu-ci-template`
        
    - _ISO Image_: –≤—ã–±–µ—Ä–∏ ISO —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Cloud-Init (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ubuntu-22.04-live-server.iso`)
        
- –ù–∞ –≤–∫–ª–∞–¥–∫–µ **System**:
    
    - BIOS: `OVMF (UEFI)` (–µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UEFI) –∏–ª–∏ `SeaBIOS`
        
    - Machine: `q35`
        
    - **Important**: –≤—ã–±–µ—Ä–∏ **SCSI** –¥–ª—è –¥–∏—Å–∫–∞, **VirtIO** –¥–ª—è —Å–µ—Ç–∏
        
- **–î–∏—Å–∫**: –ø–æ—Å—Ç–∞–≤—å `scsi0`, —Ñ–æ—Ä–º–∞—Ç `qcow2`, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `local-lvm` (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)
    
- **Network**: `VirtIO (paravirtualized)`
    

---

### 2. üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –û–° –≤–Ω—É—Ç—Ä–∏ VM

–£—Å—Ç–∞–Ω–æ–≤–∏ –û–° –∫–∞–∫ –æ–±—ã—á–Ω–æ (Ubuntu/Debian/CentOS –∏ –¥—Ä.).

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
sudo apt update && sudo apt install cloud-init qemu-guest-agent -y
sudo systemctl enable --now qemu-guest-agent
```

–ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Cloud-Init:

```bash
cat /etc/cloud/cloud.cfg
```

–£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç–∞–º –µ—Å—Ç—å `datasource_list: [ NoCloud, ConfigDrive ]`.

---

### 3. üßπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±—Ä–∞–∑–∞

–û—á–∏—Å—Ç–∏ –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```bash
sudo cloud-init clean
sudo rm -f /etc/ssh/ssh_host_*
sudo truncate -s 0 /var/log/wtmp /var/log/btmp
sudo rm -f /etc/machine-id
sudo touch /etc/machine-id
history -c
```

---

### 4. üîí –í—ã–∫–ª—é—á–∏ VM

```bash
qm shutdown 9000
```

---

### 5. ‚ûï –î–æ–±–∞–≤—å –¥–∏—Å–∫ cloud-init

–í –∫–æ–Ω—Å–æ–ª–∏ Proxmox –∏–ª–∏ Web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

```bash
qm set 9000 --ide2 local-lvm:cloudinit
qm set 9000 --boot c --bootdisk scsi0
qm set 9000 --serial0 socket --vga serial0
```

–≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π Cloud-Init-–¥–∏—Å–∫.

---

### 6. üßä –ü—Ä–µ–≤—Ä–∞—Ç–∏ –≤ —à–∞–±–ª–æ–Ω

```bash
qm template 9000
```

---

## üöÄ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞

```bash
qm clone 9000 101 --name ubuntu-test --full
```

---

## ‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloud-Init –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π VM

```bash
qm set 101 \
  --ciuser=ansible \
  --cipassword=SuperSecret123 \
  --sshkey="$(cat ~/.ssh/id_rsa.pub)" \
  --ipconfig0="ip=192.168.122.101/24,gw=192.168.122.1" \
  --hostname=ubuntu-test
```

### –ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

|–ü–∞—Ä–∞–º–µ—Ç—Ä|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|
|`--ciuser`|–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–∑–¥–∞—Å—Ç Cloud-Init|
|`--cipassword`|–ü–∞—Ä–æ–ª—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è|
|`--sshkey`|–ü—É–±–ª–∏—á–Ω—ã–π SSH-–∫–ª—é—á|
|`--ipconfig0`|–°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `net0`|
|`--hostname`|–ò–º—è —Ö–æ—Å—Ç–∞|

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞

1. –ó–∞–ø—É—Å—Ç–∏ VM:
    
    ```bash
    qm start 101
    ```
    
2. –ü–æ–¥–∫–ª—é—á–∏—Å—å —á–µ—Ä–µ–∑ SSH:
    
    ```bash
    ssh ansible@192.168.122.101
    ```
    

---

## ‚ú® –ü—Ä–∏–º–µ—Ä Cloud-Init –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∫–∞–∑–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π **user-data**:

```bash
qm set 101 --cicustom "user=local:snippets/my-user.yaml"
```

–ê —Ñ–∞–π–ª `my-user.yaml` –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–∫–∏–º:

```yaml
#cloud-config
hostname: test-vm
users:
  - name: ansible
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3...
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢—ã –ø–æ–ª—É—á–∞–µ—à—å —à–∞–±–ª–æ–Ω, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–Ω–æ **–º–∞—Å—Å–æ–≤–æ –∏ –±—ã—Å—Ç—Ä–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å** –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: –∏–º–µ–Ω–∞–º–∏, IP, –ø–∞—Ä–æ–ª—è–º–∏ –∏ SSH-–¥–æ—Å—Ç—É–ø–æ–º.

---

### üìé A. –ö–∞–∫ –∑–∞–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ VM —á–µ—Ä–µ–∑ cloud-init?

### üìé B. –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π `user-data` –∏ `meta-data` –¥–ª—è CI?

### üìé C. –ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å —Å—Ä–∞–∑—É —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–µ—Ä–µ–∑ DHCP –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è IP –≤—Ä—É—á–Ω—É—é?