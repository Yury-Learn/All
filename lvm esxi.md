#lvm 

## 1. Процесс переноса iSCSI LUN 

Процесс переноса iSCSI LUN на другое Linux-устройство с выполнением дополнительных шагов, связанных с работой с LVM.

### Шаг 1: Отключение LVM от ESXi

Следуйте основным шагам для безопасного отключения iSCSI LUN от ESXi, как описано ранее. Убедитесь, что:
- Виртуальная машина выключена.
- Диск корректно отключен от настроек виртуальной машины.
- LUN отключен от ESXi без удаления данных.

### Шаг 2: Подключение LUN к новому устройству Linux с поддержкой LVM

После того как iSCSI LUN будет отключен от ESXi, его можно подключить к новому устройству Linux с корректной настройкой LVM.

#### 1. **Настройка iSCSI Initiator на новом устройстве**:
   Как было описано ранее, настройте iSCSI Initiator и подключитесь к iSCSI Target:

   ```bash
   sudo iscsiadm -m discovery -t st -p <IP_адрес_iSCSI_Target>
   sudo iscsiadm -m node -T <имя_iSCSI_цели> -p <IP_адрес_iSCSI_Target> --login
   ```

#### 2. **Проверка устройств с помощью LVM**:
   После подключения iSCSI LUN с LVM, система должна распознать новый диск. Используйте команду `lsblk` или `fdisk -l`, чтобы найти новое устройство, например, `/dev/sdb`.

   Далее нужно убедиться, что система распознала физические тома (Physical Volumes, PV), группы томов (Volume Groups, VG) и логические тома (Logical Volumes, LV), которые были ранее настроены на этом диске.

   Выполните следующие команды для проверки:

   ```bash
   sudo pvscan
   sudo vgscan
   sudo lvscan
   ```

   Эти команды просканируют систему на наличие новых физических и логических томов.

#### 3. **Активация Volume Group**:
   Если система обнаружила группу томов (VG), она может быть неактивна. Чтобы активировать группу томов и дать доступ к логическим томам, выполните:

   ```bash
   sudo vgchange -ay <имя_группы_томов>
   ```

   Это команда активирует Volume Group и сделает доступными все связанные с ней логические тома.

#### 4. **Проверка логических томов**:
   После активации Volume Group проверьте логические тома (LV). Логические тома будут доступны как блоковые устройства в `/dev/<имя_VG>/<имя_LV>`.

   Например, если ваша группа томов называется `vg_data`, а логический том — `lv_storage`, вы сможете найти его как `/dev/vg_data/lv_storage`.

#### 5. **Монтирование логических томов**:
   Теперь вы можете смонтировать логический том в файловую систему. Если на логическом томе уже есть файловая система, выполните:

   ```bash
   sudo mount /dev/<имя_VG>/<имя_LV> /mnt
   ```

   Например:

   ```bash
   sudo mount /dev/vg_data/lv_storage /mnt
   ```

   Это сделает ваши данные доступными на новом устройстве Linux.

### Шаг 3: Настройка постоянного подключения (опционально)

Если вам нужно, чтобы тома LVM автоматически подключались при перезагрузке:

1. Добавьте iSCSI Target в автозагрузку:

   ```bash
   sudo iscsiadm -m node -T <имя_iSCSI_цели> --op update -n node.startup -v automatic
   ```

2. Обновите файл `/etc/fstab`, чтобы монтирование логического тома происходило автоматически:

   ```bash
   /dev/<имя_VG>/<имя_LV> /mnt ext4 defaults 0 0
   ```

### Важные моменты:

- **Совместимость LVM**: Убедитесь, что версии LVM на старом и новом устройствах совместимы. Обычно проблем не возникает, но в случае сильно разных версий могут возникнуть ошибки при активации группы томов.
- **Резервное копирование данных**: Перед переносом важно убедиться, что у вас есть резервная копия данных, на случай непредвиденных проблем.
- **Идентификаторы томов**: В некоторых случаях могут возникнуть конфликты с идентификаторами Volume Group. Это происходит, если на новом устройстве уже существует группа томов с таким же именем. В таком случае вам может потребоваться переименовать группу томов с помощью команды:

   ```bash
   sudo vgrename <старое_имя_VG> <новое_имя_VG>
   ```

   После этого обновите пути в настройках монтирования.


## 2. Сценарий проверки
 
Для проверки я создал LUN с именем TLVM с iscsi-target iqn.2004-04.com.qnap:ts-1283xu-rp:iscsi.target-0.7e775a без CHAP по адресу 10.38.22.6. 
1. LUN нужно подключить к машине redos1 10.38.22.76; 
2.  Потом создать из этого LUN один диск на 15 ГБ исоздать из него lvm именем tlvm. записвываем информацию весом в 1Гб с именем info1. Файловая система ext4; 
3.  Создать из оставшегося пространства ещё один диск и присоединить его к tlvm. записываем файл весом 2 Гб с именем info2 и info.txt с записью Hello, World!; 
4.  Посе этого отключаем LUN от redos1. Или как правилно сделать? ; 
5. Подключаем LUN TLVM к машине redos2 10.38.22.77; 6. Нужно чтобы файлы info.txt info1 и info2 были видны и info.txt можно было редактировать любым пользователем.

Для выполнения вашей задачи по работе с iSCSI LUN и LVM на двух машинах redos1 и redos2, выполните следующие шаги:

### Шаг 1: Подключение iSCSI LUN к redos1 (10.38.22.76)

1. **Настройка iSCSI Initiator**:
   - Установите и настройте iSCSI на redos1:

   ```bash
   sudo apt update
   sudo apt install open-iscsi
   sudo dnf install iscsi-initiator-utils
   ```

2. **Подключение к iSCSI Target**:
   - Найдите и подключитесь к вашему iSCSI Target:

   ```bash
   sudo iscsiadm -m discovery -t st -p 10.38.22.6
   sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-1283xu-rp:iscsi.target-0.7e775a --login
   ```

   Это подключит LUN TLVM к redos1.

3. **Проверка подключения**:
   - Убедитесь, что устройство распознано системой:

   ```bash
   lsblk
   ```

   Новый диск должен отобразиться, например, как `/dev/sdb`.

### Шаг 2: Создание LVM и файловой системы

1. **Создание физического тома (PV)**:
   - Инициализируйте LUN как физический том для LVM:

   ```bash
   sudo pvcreate /dev/sdb
   ```

2. **Создание группы томов (VG)**:
   - Создайте группу томов с именем `tlvm`:

   ```bash
   sudo vgcreate tlvm /dev/sdb
   ```

3. **Создание логического тома (LV)** для 15 ГБ:
   - Создайте первый логический том размером 15 ГБ:

   ```bash
   sudo lvcreate -L 15G -n lv_data tlvm
   ```

4. **Создание файловой системы ext4**:
   - Создайте файловую систему ext4 на первом логическом томе:

   ```bash
   sudo mkfs.ext4 /dev/tlvm/lv_data
   ```

5. **Монтирование логического тома и запись данных**:
   - Создайте точку монтирования и примонтируйте том:

   ```bash
   sudo mkdir /mnt/lv_data
   sudo mount /dev/tlvm/lv_data /mnt/lv_data
   ```

   - Запишите файл размером 1 ГБ:

   ```bash
   sudo fallocate -l 1G /mnt/lv_data/info1
   ```

### Шаг 3: Добавление второго логического тома

1. **Создание второго логического тома (LV)** из оставшегося пространства:
   - Создайте логический том из оставшегося пространства:

   ```bash
   sudo lvcreate -l 100%FREE -n lv_data2 tlvm
   ```

2. **Добавление второго тома в Volume Group**:
   - Присоедините второй том к группе:

   ```bash
   sudo lvextend /dev/tlvm/lv_data /dev/tlvm/lv_data2
   ```

3. **Запись данных на второй том**:
   - Создайте второй файл объемом 2 ГБ и файл `info.txt` с содержимым "Hello, World!":

   ```bash
   sudo fallocate -l 2G /mnt/lv_data/info2
   echo "Hello, World!" | sudo tee /mnt/lv_data/info.txt
   ```

### Шаг 4: Отключение iSCSI LUN от redos1

1. **Отключение тома от системы**:
   - Отмонтируйте логический том:

   ```bash
   sudo umount /mnt/lv_data
   ```

2. **Отключение LVM**:
   - Деактивируйте группу томов:

   ```bash
   sudo vgchange -an tlvm
   ```
```sh
sudo sync
```
3. **Отключение iSCSI Target**:
   - Отключите iSCSI с помощью команды:

   ```bash
   sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-1283xu-rp:iscsi.target-0.7e775a --logout
   ```

### Шаг 5: Подключение LUN TLVM к redos2 (10.38.22.77)

1. **Повторите подключение iSCSI LUN на redos2**:
   - Настройте и подключитесь к iSCSI Target на redos2 по аналогии с redos1:

   ```bash
   sudo iscsiadm -m discovery -t st -p 10.38.22.6
   sudo iscsiadm -m node -T iqn.2004-04.com.qnap:ts-1283xu-rp:iscsi.target-0.7e775a --login
   ```

2. **Активация LVM на redos2**:
   - Активируйте группу томов:

   ```bash
   sudo vgscan
   sudo vgchange -ay tlvm
   ```

3. **Монтирование логического тома**:
   - Создайте точку монтирования и примонтируйте логический том:

   ```bash
   sudo mkdir /mnt/lv_data
   sudo mount /dev/tlvm/lv_data /mnt/lv_data
   ```

### Шаг 6: Проверка данных и редактирование

1. **Проверьте файлы**:
   - Убедитесь, что файлы `info1`, `info2` и `info.txt` присутствуют:

   ```bash
   ls /mnt/lv_data
   ```

2. **Настройка прав для редактирования файла `info.txt`**:
   - Измените права доступа, чтобы любой пользователь мог редактировать `info.txt`:

   ```bash
   sudo chmod 666 /mnt/lv_data/info.txt
   ```

Теперь файл `info.txt` доступен для редактирования любым пользователем.

Этот процесс позволит вам безопасно перенести iSCSI LUN с одного сервера на другой.

### Шаг 7:  Подключения группы томов LVM через `fstab` с использованием UUID
####  1. Получение UUID логического тома

1. **Проверьте UUID вашего логического тома**:
   Используйте команду `blkid`, чтобы узнать UUID логического тома, который вы хотите монтировать:

   ```bash
   sudo blkid /dev/tlvm/lv_data
   ```

   Пример вывода:

   ```bash
   /dev/tlvm/lv_data: UUID="12345678-1234-1234-1234-123456789abc" TYPE="ext4"
   ```

   В данном случае, `UUID="12345678-1234-1234-1234-123456789abc"` — это UUID, который нужно использовать.

#### 2. Настройка монтирования через `fstab`

1. **Откройте файл `/etc/fstab` для редактирования**:

   ```bash
   sudo nano /etc/fstab
   ```

2. **Добавьте запись для логического тома**:
   Используя полученный UUID, добавьте строку для автоматического монтирования. Строка будет выглядеть так:

   ```
   UUID=12345678-1234-1234-1234-123456789abc /mnt/lv_data ext4 defaults 0 2
   ```

   - `UUID=12345678-1234-1234-1234-123456789abc` — это UUID вашего логического тома.
   - `/mnt/lv_data` — точка монтирования.
   - `ext4` — файловая система.
   - `defaults` — стандартные параметры монтирования.
   - `0` — не использовать для резервных копий `dump`.
   - `2` — порядок проверки файловой системы при загрузке (обычно корневая файловая система имеет значение 1, остальные — 2).

#### 3. Проверка и монтирование

1. **Проверьте синтаксис файла `/etc/fstab`**:
   Перед тем как перезагружать систему, проверьте, нет ли ошибок в синтаксисе файла `fstab`:

   ```bash
   sudo mount -a
   ```

   Если ошибок нет, файловая система должна примонтироваться. Проверьте это:

   ```bash
   df -h
   ```

2. **Перезагрузка**:
   Чтобы убедиться, что монтирование происходит автоматически при старте системы, выполните перезагрузку:

   ```bash
   sudo reboot
   ```

   После перезагрузки том должен быть автоматически примонтирован в указанную точку `/mnt/lv_data`.

Теперь ваш логический том будет подключаться автоматически при запуске системы через файл `fstab`, используя UUID.