---
tags:
  - update
  - "#linux"
  - cli
  - bash
---
# Список машин
### Linux 
- KSB-KMS(22.31)
- KSB-Redmine(22.202)v2
- KSB-Trueconf(89.78)
- KSB-CA(22.93)
- KSB-Zammad
- KSB-xWiki(22.203)
- KSB-NextCloud(89.51)
- KSB-PassBolt (22.105)
- Test_SPM(22.62)
- KSB-UpTime(89.178)
- KSB-Mail
### Windows Server
- KSB-AD-DC1(22.4)
- KSB-AD-DC2(22.5)
- KSB-AD-DC3(22.8)
- KSB-Service(22.7)
- KSB-Storage(22.36)

# Методология 
---
==**BACKUP**  **BACKUP**  **BACKUP** **BACKUP**  **BACKUP**  **BACKUP** **BACKUP**  **BACKUP**  **BACKUP** **BACKUP**== 

---
## Подготовка системы к обновлению Debian

1. Cохранить список текущих установленных пакетов
`dpkg -l > ~/dpkg-full.list`

2. Проверьте на всякий случай версию текущей системы. Обновление Debian с одного релиза на другой поддерживается только в рамках перехода на одну версию вверх. То есть у вас должна быть полностью обновлённая система Debian 11.
```
hostnamectl
lsb_release -a
cat /etc/debian_version
apt update && apt upgrade && apt dist-upgrade && apt --purge autoremove
```
- разберем каждую часть команды `apt update...` :
	 1. **apt update**: Эта команда обновляет списки пакетов для репозиториев, настроенных в системе. Она получает информацию о доступных пакетах и их версиях из репозиториев, но не устанавливает и не обновляет никакие пакеты.
	2. **apt upgrade**: Эта команда обновляет установленные пакеты до последних доступных версий из репозиториев. Она устанавливает самые новые версии всех пакетов, установленных на системе в данный момент. Она не удаляет никакие пакеты и не устанавливает новые пакеты.
	 2. **apt dist-upgrade**: Эта команда выполняет обновление дистрибутива, включая умное управление зависимостями и установку или удаление пакетов по мере необходимости для обновления всей системы до последней доступной версии. Это более агрессивная команда, чем обычное обновление, и может устанавливать новые зависимости или удалять существующие, если это необходимо.
	 4. **apt --purge autoremove**: Эта команда удаляет пакеты, которые были автоматически установлены для удовлетворения зависимостей других пакетов, но больше не нужны. Опция `--purge` удаляет файлы конфигурации вместе с пакетами, обеспечивая их полное удаление из системы. Действие `autoremove` специально направлено на автоматически установленные пакеты, которые больше не требуются ни одним из ранее установленных вручную пакетов.
- Команда `lsb_release -a` используется для вывода информации о версии и идентификационных данных операционной системы на базе Linux.
	1. **Distributor ID**: Идентификатор дистрибутива операционной системы.
	2. **Description**: Описание операционной системы.
	3. **Release**: Версия операционной системы.
	4. **Codename**: Кодовое имя версии операционной системы.
- Команда `cat /etc/debian_version` выводит версию Debian

В общем случае рекомендуется удалить все пакеты, которые были установлены не из стандартных репозиториев и отключить сами репозитории. Проверить такие пакеты можно следующим образом:
`apt list '?narrow(?installed, ?not(?origin(Debian)))'`
Рекомендация по корректному обновлению такова — все неродные пакеты удаляем, после обновления ставим заново, если они поддерживают новую версию Debian. Если нет, то обновление откладываем и каким-то образом решаем эту проблему.

## Обновление списка репозиториев
1. Cохраним sources.list
`cp /etc/apt/sources.list ~/sources.list`

2. Обновляем файл с репозиториями _/etc/apt/sources.list_, изменив релиз с bullseye на bookworm
```
echo -e "deb https://deb.debian.org/debian bookworm main" | sudo tee /etc/apt/sources.list
echo -e "deb-src https://deb.debian.org/debian bookworm main" | sudo tee -a /etc/apt/sources.list
```
```
echo -e "deb https://deb.debian.org/debian bookworm-updates main" | sudo tee -a /etc/apt/sources.list
echo -e "deb-src https://deb.debian.org/debian bookworm-updates main" | sudo tee -a /etc/apt/sources.list

```
```
echo -e "deb http://security.debian.org/ bookworm-security main" | sudo tee -a /etc/apt/sources.list
echo -e "deb-src http://security.debian.org/ bookworm-security main" | sudo tee -a /etc/apt/sources.list
```
 Если вы использовали прошивки (firmware) из репозитория non-free, подключите репозиторий non-free-firmware для их обновления.
`echo -e "deb https://deb.debian.org/debian bookworm main non-free-firmware" | sudo tee -a /etc/apt/sources.list`
- Команда `| sudo tee /etc/apt/sources.list` : 
	1. Символ `|` используется для передачи вывода предыдущей команды в следующую команду. 
	2. `tee` - это утилита командной строки, которая считывает из стандартного ввода и записывает в стандартный вывод и одновременно в файлы. Здесь мы используем `tee` с `sudo`, чтобы получить права суперпользователя и записать вывод в файл `/etc/apt/sources.list`.

3. проверить список репозиториев
`cat /etc/apt/sources.list`

4. Выполняем обновление списка пакетов из нового репозитория:
`apt update`


## Обновление

5. Теперь убедитесь, что у вас есть достаточно свободного места на корневом разделе для продолжения обновления. Количество необходимого места зависит от набора пакетов. Посмотреть его можно с помощью следующей команды:
```sh
apt -o APT::Get::Trivial-Only=true full-upgrade
```
 - команда `apt -o APT::Get::Trivial-Only=true full-upgrade` :
	1. **apt**: Это инструмент управления пакетами в Debian и его производных дистрибутивах (таких как Ubuntu).
    2. **-o APT::Get::Trivial-Only=true**: Этот флаг позволяет задавать параметры конфигурации для apt непосредственно из командной строки. Здесь мы используем параметр `APT::Get::Trivial-Only`, чтобы указать, что тривиальные изменения пакетов должны быть рассмотрены как незначительные. Установка этого параметра в `true` означает, что apt должен игнорировать предупреждения о несущественных изменениях.
    3. **full-upgrade**: Этот аргумент обновляет систему до новых версий пакетов, решая все конфликты, в том числе и те, которые могут потребовать удаления пакетов или установку новых пакетов. Он выполняет более радикальное обновление, чем просто `upgrade`.    
	Таким образом, данная команда обеспечивает полное обновление системы, при этом игнорируя предупреждения о несущественных изменениях пакетов. Однако, будьте осторожны при использовании этой команды, так как она может привести к удалению или изменению пакетов на вашей системе.

6. Если места недостаточно, то можно выполнить некоторые чисти, связанные с работой пакетного менеджера:
```sh
apt autoremove
apt clean
```
- Описание:
	1. **apt autoremove**: Эта команда сканирует систему на наличие пакетов, которые были установлены как зависимости для других пакетов, но больше не требуются. Затем она предлагает удалить эти пакеты, освобождая место на диске и помогая поддерживать систему в чистом состоянии.
	2. **apt clean**: Эта команда очищает кэш APT от загруженных файлов пакетов. Когда вы используете APT для установки или обновления пакетов, они загружаются и временно хранятся в кэше. Команда `apt clean` удаляет все эти загруженные файлы, освобождая место на диске.

7. Далее запускаем минимальное обновление, которое не требует установки новых пакетов или удаления старых. Обязательно запускайте его через **screen** или **tmux**. В случае обрыва связи при подключении по **ssh**, могут произойти непрогнозируемые проблемы с работоспособностью системы. Процесс обновления обязательно должен полностью завершиться успешно.
```sh
apt upgrade --without-new-pkgs
```
>Не сворачивайте консоль, так как в процессе обновления Debian 11 до 12 вам будут задавать некоторые вопросы. Можно выбирать значения по умолчанию и всё пройдёт успешно. Первым делом вам предложат ознакомиться со списком изменений и выйти из режима чтения, нажав **q**.

8. Только если всё прошло успешно на предыдущем шаге, запускайте полное обновление Debian 11:
`apt full-upgrade`
>Здесь, опять же, не уходите далеко. Вам будут задавать вопросы в процессе установки обновлений.
9. Когда работа команды завершится успешно, можно считать, что обновление завершено. Останется только перезагрузить сервер.
`systemctl reboot`