#disk #linux 


Небольшая шпаргалка с командами, которая пригодится, когда у вас закончилось свободное место на дисках на сервере под управлением Linux. 

- Смотрим, что у нас вообще по занимаемому месту:
`df -h`
- Если в какой-то точке монтирования занято на 100% свободное место, можно быстро посмотреть, в каких конкретно директориях оно занято. Тут может быть много разных вариантов:
```
du -h -d 1 / | sort -hr
du -hs /* | sort -hr
```
 - Ограничиваем вывод:
`du -h -d 1 / | sort -hr | head -10`
- Смотрим топ 20 самых больших директорий:
`du -hcx --max-depth=6 / | sort -rh | head -n 20`
- Смотрим топ 20 самых больших файлов:
```
find / -mount -ignore_readdir_race -type f -exec du -h "{}" + 2>&1 \
| sort -rh | head -n 20
```

- На всякий случай проверяем inodes. Иногда свободное место заканчивается из-за них:
`df -ih`
- Если вывод du показывает, что места свободного нет, но сумма всех директорий явно меньше занимаемого места, то надо проверить удалённые файлы, которые всё ещё держит какой-то процесс. Они не видны напрямую, посмотреть их можно через lsof:
```
lsof | grep '(deleted)'
lsof +L1
```
Если увидите там файлы большого размера, то посмотрите, какая служба их держит открытыми и перезапустите её. Обычно это помогает. Если служба зависла, то грохните её принудительно через kill -9 <pid>.

- Ещё один важный момент. Может получиться так, что du оказывает, что всё место занято. В файловой системе напрямую вы не можете найти, чем оно занято, так как сумма всех файлов и директорий явно меньше, чем занято места. Среди удалённых файлов тоже ничего нет. Тогда проверяйте свои точки монтирования. Бывает так, что у вас, к примеру, скриптом монтируется сетевой диск в /mnt/backup и туда копируются бэкапы. А потом диск отключается. Если по какой-то причине в момент бэкапа диск не подмонтируется, а данные туда скопируются, то они все лягут на корневую систему, хоть и в папку /mnt/backup. Если после этого туда смонтировать сетевой диск, то ранее скопированные файлы будут не видны, но они будут занимать место. Ситуация хоть и кажется довольно редкой, но на самом деле она иногда случается и я сам был свидетелем такого. И читатели писали такие же истории. Вот одна из них (https://t.me/srv_admin/1732). Поэтому если скриптом подключаете диски, то всегда проверяйте, успешно ли они подключились, прежде чем копировать туда файлы. Вот примеры (https://t.me/srv_admin/3293), как это можно сделать.  

---

 apt install duf

Когда первый раз про неё писал (https://t.me/srv_admin/1229), её там не было. Качал бинарник вручную. Рассказывать про неё особо нечего. Так же, как и df, duf показывает использование диска разных устройств и точек монтирования. Вывод более наглядный, чем в df. Плюс, есть несколько дополнительных возможностей, которые могут быть полезны:

▪️ Умеет делать вывод в формате json:
 duf -json

▪️ Умеет сразу сортировать по разным признакам:
 duf -sort size
 duf -sort used
 duf -sort avail

▪️ Умеет группировать и сортировать устройства:
 duf --only local
 duf --only network
 duf --hide local
#duf --only-mp /,/mnt/backup
и т.д. 

То есть эта штука удобна не только для визуального просмотра через консоль, но и для использования в различных костылях, велосипедах и мониторингах. Не нужно парсить регулярками вывод df, а можно отфильтровать, выгрузить в json и обработать jq. Написана duf на GO, работает шустро. Хороший софт, можно брать на вооружение.